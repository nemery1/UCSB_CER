
---
title: 'UCSB Course Equity Report: CHE 126'
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
#setup 

#hide code, warnings, and messages by default
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, messages = FALSE)

#use pacman to install and load all packages required
if (!require("pacman")) install.packages("pacman") #install pacman if not already installed

#note to users: pacman installs the latest package version. 
#comments below indicate package version the code was initially tested on. 
#to install a specific version using pacman, use command `p_installversion()` 

pacman::p_load(tidyverse, #code tested on v.2.0.0
               Hmisc, #code tested using v.4.7-1
               rmdformats, #output format: readthedown (v.1.0.4)
               kableExtra, #pretty html tables (v.1.3.4)
               gghalves, #half-half geoms (v.0.1.4)
               ggdist, #density plots for distributions (v.3.2.1)
               viridis, #colorblind-friendly palettes (v.0.6.2)
               knitr, #(v.1.40)
               pander) # for text processing (v.0.6.5)

#create shared plot settings
theme_seismic <- 
  theme_classic(base_size = 14) + 
  theme(axis.text = element_text(color = "black"), 
        strip.text = element_text(color = "black"), 
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1)) + 
    theme(plot.caption = element_text(size = 9, hjust = 0.5)) 

#create SEISMIC color palettes
#note: SEISMIC colors are NOT colorblind friendly. 
seismic_colors <- c("#eb7e36","#4671c6","#70ac49","#a6a6a6","#ffbe07", "#429dda","#B35050","#7ed233")
```

```{css css textbox formatting, echo = FALSE}
.questionbox {
  padding: 1em;
  background:#DFDFDF;
  color: black;
  border: 2px solid maroon;
  font-size: 18 px
}

.center {
  text-align: center;
}
```

```{r load data, echo = FALSE}
#load data 
#change this file name to the source of your properly formatted data file 
dat <- read.csv(file = "C:/Users/User/Box/Equity Reports/CHE126/DATA_FILE.csv")

```

```{r select course of interest}
#if the dataset has more than one course in it, define the course of interest here
#what you enter must match the course name in the dataset
course_of_interest <- "CHE126"
```

```{r define majors of interest, include = FALSE}
#define the majors you are specifically interested in plotting and exploring in your dataset
#entries must match the names in the dataset verbatim
majors_of_interest <- c("ECE/CMPSC")
```

```{r set cutoffs for sample size, include = FALSE}
#what is the sample size cutoff for small groups you do not want to include in the analyses?

#general demographic cutoff
#this cutoff will be used for general demographic groups, such as all students of an ethnicity
#e.g. if there are less than N Indigenous/Native American students, for example, they will not be plotted
cutoff_general <- 15

#by section cutoff
#this cutoff will be used when demographic groups are sorted by individual course offerings
#e.g. if there are less than N PEER students in a particular course offering/term, they will not be plotted 
cutoff_sections <- 15
```

# 1. Introduction

The goal of this report is to allow faculty and department leaders to view institutional data from their courses of interest to evaluate whether students experience equitable outcomes in those courses.

We want to emphasize that the student identities explored here are not exhaustive. There are many identities and lived experiences that may influence how students interact with a course and thus affect course outcomes. The manner in which data are presented is intended to help an instructor understand the effects of structural inequities in higher education. We seek to balance the many unique and intersecting student identities with meaningful, interpretable categories of student identity. As you read through this report, remember that each data point represents an individual who deserves the opportunity to succeed in the course.

::: {.center data-latex=""}
**The course of interest is `r course_of_interest`.**

**The course data presented in this report ranges from `r min(dat$crs_year)` to `r max(dat$crs_year)`.**
:::

# 2. Who is in this course?

Before evaluating student course outcomes, it is important to understand: who takes this course? What demographic and academic groups do students in this course hold?

[Figure 1] 
The plot below shows the percent of students across all terms of the course of interest that hold the following identities: 
- Declared a STEM major
- Transferred from another 2- or 4- year institution
- International students or are permanent residents 
- Come from a low socioeconomic background
- Are the first in their family to go to college or pursue a Bachelor's degree (first-generation, or FirstGen)
- Identify as a women
- Are People/Persons historically Excluded based on Ethnicity or Race (PEER; [Asai 2020](https://www.cell.com/cell/pdf/S0092-8674(20)30337-8.pdf)).
The definition of PEER closely aligns with the definition of "underrepresented minorities" used by the National Science Foundation ([NSF 2023](https://ncses.nsf.gov/pubs/nsf23315/report/glossary#:~:text=Underrepresented%20minorities%3A%20Races%20or%20ethnicities,American%20Indians%20or%20Alaska%20Natives.)).

Note that these identities are not mutually exclusive; a single student can belong to any or all of these groups.

**Figure 1**
```{r percent by identity, message=FALSE, warning=FALSE}
#bar plot with percent of all students in the class by demographics

#underlying table

demog_percent <-
dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) %>%
  #add n for all students in course
  add_tally(name = "n_course") %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  group_by(demo_var, value) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_course)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  #select only students that belong to marginalized backgrounds
  filter(value == 1)

#plot ####

demog_percent %>%
  #rename labels to be more interpretable
  mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
ggplot(aes(x = demo_var, y = perc, fill = demo_var)) + 
  #add barplot for percent
  geom_col(color = "black") + 
  #add labels for actual percent values
  geom_text(aes(label = round(perc,0)), hjust = -1) + 
  #add separating line between academic and demographic values
  geom_vline(xintercept = 5.5) + 
  #annotate the sections
  annotate(geom = "text", x = c(6,5), y = 75, label = c("Academic", "Demographic") ) +
  labs(x = "Student identity", y = "Percent of class (%)") + 
  scale_fill_manual(values = seismic_colors) + 
  #set y axis to 100
  ylim(0,100)+
  theme_seismic +
  #hide redundant color legend
  theme(legend.position = "none") + 
  coord_flip()
```

Identifying students using "PEER" may mask the unique classroom experiences faced by different ethnic and racial groups. By disaggregating data, we are empowered to learn about these unique experiences and inform decisions for courses, curricula, and other academic practices. 

The following plot shows the percent of students in the course of interest (across all terms), broken down by specific race/ethnicity.

**Figure 2**
```{r percent by ethnicity, message=F, warning=F}
#Create a list of labels of ethnicities to be more interpretable for x axis labels
ethnicity_labels <- c("white"= "White", "black_afram" = "Black/African-American", "hispanic_latinx" = "Hispanic/Latinx/Chicanx", "indigenous_am_indian" = "Indigenous/American Indian", "asian" = "Asian", 
                      "pacific_islander" = "Pacific Islander/Native Hawaiian") 

#percent of class, disaggregated by specific ethnicities: 
dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) %>%
  #add n for all students in course
  add_tally(name = "n_course") %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(white, black_afram, hispanic_latinx, indigenous_am_indian, asian, pacific_islander),
               names_to = "ethnicity",
               values_to = "value") %>% 
  group_by(ethnicity, value) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_course)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  #select only students that belong to marginalized backgrounds
  filter(value == 1) %>%
  #PLOT #
  ungroup() %>%
  mutate(ethnicity = forcats::fct_reorder(ethnicity, desc(perc))) %>% 
ggplot(aes(x = ethnicity, y = perc, fill = ethnicity)) + 
  #add barplot for percent
  geom_col(color = "black") + 
  #add labels for actual percent values
  geom_text(aes(label = round(perc,0)), hjust = -1) + 
  labs(x = "Student ethnicity", y = "Percent of class (%)") + 
  #ylim
  ylim(0,100)+
  scale_x_discrete(labels = ethnicity_labels) + 
  #use seismic color pallette
  scale_fill_manual(values = seismic_colors) + 
  theme_seismic +
  #hide redundant color legend
  theme(legend.position = "none") +
  coord_flip()

```


::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   Do any of the percentages of students in the course surprise you? In what way?
-   What groups are *not* included in these figures?
-   How do students from these groups engage with your course differently? Why?
-   How could you structure your course so that students from all identities feel welcome and want to engage with course content and discussions?
:::

## How have these demographics changed over time?

While overall percentages are informative, we can also examine trends in representation of these different student groups across course terms. The timing of course offerings may affect which students take your course in a given term.

The below plot shows the percent of students in *each term* of the course of interest across the range of terms in the dataset. Student identities are shown in different colored lines over time. Individual terms (winter, spring, summer or fall) are labeled on the x-axis.

**Figure 3**
```{r percent by identity - over time, message=FALSE, warning=FALSE}
#different identities with the percent over time
  #could be facet grid or not

dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) %>%
  #add n for all students in term
  add_count(crs_year, crs_semq, name = "n_term") %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #group by course section
  group_by(crs_year, crs_semq, demo_var, value) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_term)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  #select only students that belong to marginalized backgrounds
  filter(value == 1) %>%
  #create a semq text label for more clear x axis labels 
  mutate(semq_text = recode(as.character(crs_semq), "1" = "W", "2" = "Sp", "3" = "SuI", "4" = "SuII", "5" = "F")) %>%
  #create a crs_section variable to maintain x axis chronological ordering
  mutate(crs_section = paste0(crs_year, crs_semq)) %>%
  #create course label that orders readable labels create above chronologically
  mutate(crs_label = forcats::fct_reorder(as.factor(paste0(semq_text, crs_year)), as.integer(crs_section))) %>%
  #rename demographic labels to be more interpretable
  mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  #remove missing demographic variables before plotting
  drop_na(demo_var) %>%
  #PLOT 
ggplot(aes(x = crs_label, y = perc, color = demo_var)) + 
  geom_point(aes(shape = semq_text), size = 2) + #shape corresponds to term
  geom_line(aes(group = demo_var)) + 
  labs(x = "Course Term", y = "Percent of class (%)",
       color = "Student identity", shape = NULL) + 
  #optional: separate plots for each demographic variable
  #facet_wrap(~demo_var) + 
  #use seismic color palette
  scale_color_manual(values = seismic_colors) + 
  scale_shape_discrete(labels = c("F" = "Fall", "Sp" = "Spring", "W" = "Winter", "SuI" = "Summer I", "SuII" = "Summer II")) +
  theme_seismic + 
  theme(axis.text.x = element_text(angle = 90))

```

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   How has student representation changed over time?
-   Are there any yearly patterns or differences among summer terms and fall/winter/spring terms?
-   What changes in course content or structure might support student interests and address challenges faced by some student groups? (e.g. [Universal Design for Learning](https://id.ucsb.edu/teaching/teaching-resources/inclusive-teaching/universal-design-for-learning))
:::

## What majors do students in this course hold?

The below plot shows all students across all terms, broken down by major of study, for the top 10 most populous majors. Each bar shows the percent of students in each major. The color of the bar indicates whether the major is a STEM major, or a non-STEM major. (The overall percent of STEM majors in the course is shown in the bar plot above with the other student identities.)

**Figure 4**
```{r percent by top 10 majors, message = FALSE, warning=FALSE}
# plot percent of top 10 majors in the course by # of students

dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) %>%
  #add n for all students in course
  add_tally(name = "n_course") %>%
  group_by(major, stem_major) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_course)) %>% 
  #select only the top 10 most populous majors
  ungroup() %>% #ungroup required for slice to work 
  slice_max(n_total, n = 10, with_ties = FALSE) %>%
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  ggplot(aes(x = major, y = perc, fill = as.factor(stem_major))) +
  #add barplot for percent
  geom_col(color = "black") + 
  #add labels for actual percent values
  geom_text(aes(label = round(perc,0)), hjust = 1.2) + 
  labs(x = "Major", y = "Percent of class (%)", fill = NULL) + 
  scale_fill_manual(values = seismic_colors, 
                    labels = c("non-STEM", "STEM")) + 
  theme_seismic +
  theme(legend.position = "top") + 
  coord_flip()
```


# 3. Grades in this course

```{r create course of interest dataset (no NA grades)}
dat_coi <-
  dat %>%
  #include only the course of interest
  filter(crs_name == course_of_interest) %>%
  #exclude all observations without numeric grades for quantiative analyses
  drop_na(numgrade) %>%
  #create a true "PEER" variable that compares PEER to white/Asian combined
  mutate(peer = ifelse(ethniccode_cat == 1, 1, 0)) %>%
  #for Over Time / longitudinal analyses:
  #create a semq text label for more clear x axis labels 
  mutate(semq_text = recode(as.character(crs_semq), "1" = "W", "2" = "Sp", "3" = "SuI", "4" = "SuII", "5" = "F")) %>%
  #create a crs_section variable to maintain x axis chronological ordering
  mutate(crs_section = paste0(crs_year, crs_semq)) %>%
  #create course label that orders readable labels create above chronologically
  mutate(crs_label = forcats::fct_reorder(as.factor(paste0(semq_text, crs_year)), as.integer(crs_section)))
```

```{r get info on excluded data, include = FALSE}
#if users are intersted, this table yields information on data excluded due to having missing numgrades or GPAO

#create table: 
  dat %>%
  #include only the course of interest
  filter(crs_name == course_of_interest) %>%
  #show only those with NA numgrade or NA GPAO 
  filter(is.na(numgrade) | is.na(gpao)) %>%
  mutate(missing_Grade = ifelse(is.na(numgrade),"Y","N"),
         missing_GPAO = ifelse(is.na(gpao), "Y","N")) %>%
  group_by(missing_Grade, missing_GPAO) %>%
  summarise(N = n(), 
            N_Women = sum(female == 1),
            N_PEER = sum(ethniccode_cat == 1), 
            N_FirstGen = sum(firstgen == 1),
            N_Transfer = sum(transfer == 1), 
            N_LowIncome = sum(lowincomeflag == 1))
```

Student final grades are the main course outcome available from registrar data. In this section, we examine the distribution of grades in this courses, and explore grade patterns across groups.

## What is the grade distribution in this course?

The below plot shows the overall grade distribution for this course across all terms. Note that this plot excludes students who did not take the course for a letter grade (pass/non pass) or withdrew.

**Figure 5**
```{r overall grade distribution, warning = FALSE, message=FALSE}

dat_coi %>%
 ggplot(aes(x = fct_reorder(lettergrade, numgrade), y = after_stat(count)/sum(after_stat(count)))) +  
        geom_bar(color = "black", fill =  seismic_colors[2]) + 
        scale_y_continuous(labels = scales::percent) + 
  labs(x = "Course Grade", y = "Percent") + 
  theme_seismic
```

However, some students may enroll in the class but then end up withdrawing from the course. The below plot shows who is *NOT* succeeding in this course, by showing the percent of all students across all terms that received a D, F, or withdraw from the course with a "W" ("DFWs").

**Figure 6**
```{r overall DFW}
#plot the overall DFW rate for the course
dat %>%
  #remove plus/minus from lettergrade, if present
  filter(crs_name == course_of_interest) %>%
  mutate(lettergrade = str_replace_all(lettergrade, regex("\\W+"), "")) %>%
  mutate(dfw = ifelse(lettergrade %in% c("D","F","W"), lettergrade, "A-C")) %>%
  #add n for all students in course
  add_tally(name = "n_course") %>%
  group_by(dfw) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_course)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  ggplot(aes(x = dfw, y=perc, fill = dfw)) + 
  geom_col(color = "black") + 
  #add labels to each bar with the rounded percent for each group
  geom_text(aes(label = scales::percent(round(perc/100,2))), vjust = -0.5) + 
  #define colors, with gray for all others than DFW 
  scale_fill_manual(values = c("A-C"="lightgray","D" = seismic_colors[1], "F" = seismic_colors[2], "W" = seismic_colors[3]), guide = "none") + 
  labs(x = "Course Grade", y = "Percent(%)") + 
  theme_seismic
```

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   Does this grade distribution match what you would expect to see for this course? How does this distribution align (or not) with what you would *like* to see?

-   How might you alter your assessments or course structures to better achieve the desired distribution?

-   How well do grades represent student success in this course? What other measures of student outcomes could you use? (e.g. [Assessment possibilities](https://id.ucsb.edu/index.php/teaching/teaching-resources/assessing-learning/meaningful-assesment))

-   Are the DFW rates what you would expect for a course at this level?
:::

## How do course outcomes compare for different student groups?

While viewing the full distribution of grades would allow us to view the entire range, sometimes comparing average grades, especially between majority and historically-excluded / minoritized groups can be informative when evaluating equity in course outcomes.

The below plot shows the overall average grades for students, disaggregated by whether they hold a certain identity or not.The x-axis range has been zoomed in so we can better evaluate differences between groups.

In this plot:

-   Means and 95% confidence intervals are shown as points and error bars.

-   Student identities are represented by shape; triangles represent students in the historically excluded/minoritized group and circles are students in the majority/historically supported/accepted group.

-   The overall average grade for all students in all terms of the course is shown as a dashed line.

\*Note that it is more useful to compare between students who do and do not hold each identity than across groups, as the student identities are not mutually exclusive (a single student may belong to any and all of these identities).

**Figure 7**
```{r mean raw grade by identity, message=FALSE, warning=FALSE}
#mean grades (+/-SEM) for different identities

#calculate overall mean grade for course (will be plotted as an average line)
mean_grade_coi <- mean(dat_coi$numgrade, na.rm = T)

dat_coi %>%
  #create a true "PEER" variable that compares PEER to white/Asian combined
  mutate(peer = ifelse(ethniccode_cat == 1, 1, 0)) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(peer, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #rename labels to be more interpretable
 mutate(demo_var = factor(demo_var, 
                           levels = c("peer","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  add_count(demo_var, value, name = "n") %>%
  #PLOT
  ggplot(aes(x = demo_var, y = numgrade, color = demo_var, shape = as.factor(value))) + 
  #points for mean
  stat_summary(geom = "point", fun = "mean", size = 3) + 
  #add 95% CI errorbars
  stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", width = 0.1) + 
  #plot average line for mean grade
  geom_hline(yintercept = mean_grade_coi, linetype = "dashed") +
  #more interpretable labels for shape 
  scale_shape_discrete(labels = c("0" = "no", "1" = "yes"), name = "Student holds identity?") + 
  #use seismic colors; turn off color legend
  scale_color_manual(guide = "none", values = seismic_colors) + 
  #labels
  labs(x = "Student identity", y = "Average grade", color = "Student identity",
       caption = "Mean ± 95% CI shown \n Dashed line is overall average grade") + 
  #make points in shape legend larger
  guides(shape = guide_legend(override.aes = list(size = 3))) +
  theme_seismic + 
  coord_flip()
```

We can also examine the DFW rate across specific student demographics. The below plot shows, for each demographic variable in the dataset, the percent of all students in that group that recieved a D,F, or W (or an A-C grade). In this plot, the colors represent the Ds (orange), Fs (blue), and Ws (green) respectively, with all other students indicated in gray. The labels on each plot represent the actual percent of students that fell into each DFW category across the seven demographic and academic variables.

**Figure 8**
```{r percent DFW by identity}
dat %>%
  #remove plus/minus from lettergrade, if present
  mutate(lettergrade = str_replace_all(lettergrade, regex("\\W+"), "")) %>%
  mutate(dfw = ifelse(lettergrade %in% c("D","F","W"), lettergrade, "A-C")) %>%
  pivot_longer(cols = c(female, transfer, international, ethniccode_cat, lowincomeflag, firstgen, stem_major), 
               names_to = "demo_var", 
               values_to = "value") %>%
  #rename labels to be more interpretable
  mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  count(demo_var, value, dfw) %>%
  group_by(demo_var, value) %>%
  mutate(n_value = sum(n), 
         perc = n/n_value*100) %>%
  filter(value == 1) %>%
  ggplot(aes(x = demo_var, y = perc, fill = dfw)) + 
  geom_col(color = "black") + 
  geom_text(aes(label = round(perc, 0)), position = position_stack(vjust = 0.5)) +
  #define colors, with gray for all others than DFW 
  scale_fill_manual(values = c("A-C"="lightgray","D" = seismic_colors[1], "F" = seismic_colors[2], "W" = seismic_colors[3])) + 
  labs(y = "Percent(%)", x = NULL, fill = NULL) + 
  theme_minimal(base_size = 14) + 
  theme(axis.text = element_text(color = "black")) + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  theme(legend.position = "bottom") +
  coord_flip()
```

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   How is this course supporting students differently? Why might this course support some students better than others?

-   How might you alter course content and structure so that all students feel like they belong in this learning environment?

:::

## How have grades across student groups changed over time?

We can also evaluate how grading and grade distributions have changed over time in this course.

The below plot shows the trends over time for each student identity.

-   Each axis of identity is a separate plot.

-   Means and 95% confidence intervals are shown as points and vertical errorbars.

-   The majoritarian group (i.e., students who do not hold the indicated identity) is shown in gray circles across all plots. Students who do hold the identity are shown in colored triangles.

\*The overall course average, across all students and all terms, is shown with a dashed line. If the sample size for a group in a particular term is less than `r cutoff_sections`, then that group will not be included in the plot.

**Figure 9**
```{r mean grades by identity - over time (facets), message= FALSE, warning=FALSE,fig.height= 8, fig.width = 8}

dat_coi %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(peer, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value")  %>%
  #add a sample size for each course section, demographic variable and value 
  add_count(crs_section, demo_var, value, name = "n_sect_group") %>%
  #remove students in groups that do not meet the section / group sample size cutoff (set by user in chunk)
  filter(n_sect_group >= cutoff_sections) %>%
  #create a color code grouping based on demographic variable, with color for minoritized groups only
  mutate(color_code = ifelse(value == 0, "majority", demo_var)) %>%
  #rename labels to be more interpretable
  mutate(demo_var = factor(demo_var, 
                           levels = c("peer","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  #remove missing demographic variables before plotting
  drop_na(demo_var) %>%
  #PLOT 
  # PLOT 
ggplot(aes(x = crs_label, y = numgrade, color = color_code, shape = as.factor(value))) + 
  # mean +/- 95% CI errorbars
  stat_summary(fun.data = "mean_cl_normal") + 
  # lines that connect each group over time
  stat_summary(geom = "line", fun.data = "mean_cl_normal", aes(group = interaction(demo_var, value))) + 
  labs(x = "Course Term", y = "Course grade",
       color = "Student identity", shape = NULL) + 
  # add average line for mean grade
  geom_hline(yintercept = mean_grade_coi, linetype = "dashed") +
  # optional: separate plots for each demographic variable (note: plot very messy w/o this)
  facet_wrap(~demo_var) + 
  # use seismic color palette
  scale_color_manual(values = c("majority" = "gray",
                                "peer" = "#eb7e36", "female" = "#4671c6", "firstgen" = "#70ac49", "lowincomeflag" = "black", "international" = "#ffbe07", "transfer" = "#429dda", "stem_major" = "#B35050")) + 
  # make shape legend more interpretable
  scale_shape_discrete(name = "Student holds identity?", labels = c("0" = "no", "1" = "yes")) + 
  # set y-axis scale to range from 0 to 4
  scale_y_continuous(limits = c(0, 4)) +
  theme_seismic + 
  theme(axis.text.x = element_text(angle = 90)) + 
  # reposition legend to bottom
  theme(legend.position =  "bottom") + 
  # hide redundant color label
  guides(color = "none")

```

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   Have the overall trends in course grades been stable over time, or have they changed in recent terms?

-   If there are any overall equity gaps associated with specific student identities, have they narrowed in recent years, or widened? Are there any pedagogical or structural changes that may relate to any changes seen over time?
:::

# 4. Comparing course grades to grades in other courses

## How does overall prior performance at the university (i.e., GPAO, prior GPA) compare to student outcomes in my course?

One way we can compare outcomes in our course to students' prior performance at our institution is by calculating the **grade anomaly**. Grade anomaly subtracts a measure of student's general or prior academic performance, such as prior GPA, from their course grade. 

We are using the grade point average omitting the course of interest (**GPAO**), because this metric has been found to be the best metric of prior academic preparation in previous studies (compared to high school GPA or standardized test scores, [Koester et al.,2016](https://doi.org/10.48550/arXiv.1608.07565)). GPAO can also be especially useful for transfer students, who may not have a prior GPA at our institution if they just transferred.

Grade anomalies can be:

-   **Grade penalties** - where students receive *lower* grades in the course relative to their other coursework, or,

-   **Grade bonuses** - where students receive *higher* grades relative to other courses.

Whether a course confers a grade bonus or a grade penalty depends on what other courses students have taken, or take in the term of interest. In many ways, the grade anomaly depends on where the course is situated in the curricular context (i.e., is this course taken along with many other large introductory STEM courses, or are the other courses taken to this point general education or electives?).

\*Importantly, grade bonuses or penalties are not necessarily "good" or "bad", and it often depends on the goals of the course and the assessment structure. For example, courses that aim to evaluate students' level of mastery of specific skills or concepts as prerequisites for future coursework (a goal of many introductory STEM courses) tend to confer higher grade penalties than other courses.

First, we can explore what the distribution of course grades are versus GPAO. The plot below shows the sample size of students for different combinations of GPAO versus course grade. The line shows the one-to-one line, so areas below the line represent grade penalties (GPAO \> grade), areas above grade bonuses (GPAO \< grade). Lighter colors represent more students that fall in that quadrant.

**Figure 10**
```{r course grade vs gpao heatmap, message= FALSE, warning = FALSE}
#heatmap a la Heather Rypkema's report 
#issue: should the breaks be manually specified so there is a 1:1 on x and y axes?

#bin data for heatmap tiles
heatmap <- 
dat_coi %>%
  drop_na(gpao) %>%
  #create gpao bin
  mutate(gpaobin=.1*floor(10*gpao)) %>%
  count(gpaobin,numgrade) %>%
  complete(., gpaobin, numgrade, fill = list(n = 0))

yticks<-c(0,1,2,3,4)
glab<-c("F","D","C","B","A")

# plot heatmap
ggplot(heatmap, aes(x = gpaobin, y = numgrade, fill = n)) +
  geom_tile() + 
  geom_abline(yintercept = 0, slope = 1, linewidth = 1) + 
  scale_fill_gradient(low = "white", high = "black") +  # Set color scale to black and white
  scale_y_continuous(breaks = yticks, labels = glab) +
  scale_x_continuous(breaks = yticks, labels = glab) +
  labs(x = "GPAO", y = "Course Grade", fill = "N") + 
  theme_seismic

opts_chunk$set(fig.height = 5)

```

As with actual grades, we can also examine grade anomaly across student demographics. The below plot focuses on the mean grade anomaly for each student demographic group, comparing the majority group (circles) to the historically excluded / marginalized group (triangles). Points show means, flanked by the 95% confidence interval for each group.

**Figure 11**
```{r grade anomaly by identity, message=FALSE, warning=FALSE}

#calculate overall mean grade for course (will be plotted as an average line)
aga_coi <- mean(dat_coi$numgrade, na.rm = T) - mean(dat_coi$gpao, na.rm = T)


#different identities with average grade anomaly across identities 
dat_coi %>%
  #exclude NA GPAO
  drop_na(gpao) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(peer, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #add count for each demographic group
  add_count(demo_var, value, name = "n_group") %>%
  #exclude groups with N less than user-defined cutoff 
  filter(n_group >= cutoff_general) %>%
  #rename labels to be more interpretable
 mutate(demo_var = factor(demo_var, 
                           levels = c("peer","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  add_count(demo_var, value, name = "n") %>%
  #PLOT
  ggplot(aes(x = demo_var, y = numgrade-gpao, color = demo_var, shape = as.factor(value))) + 
  #points for mean
  stat_summary(geom = "point", fun = "mean", size = 3) + 
  #add 95% CI errorbars
  stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", width = 0.1) + 
  #plot average line for mean grade
  geom_hline(yintercept = aga_coi, linetype = "dashed") +
  #plot line and annotations for penalty vs bonus
  geom_hline(yintercept = 0) +  
  #more interpretable labels for shape 
  scale_shape_discrete(labels = c("0" = "no", "1" = "yes"), name = "Student holds identity?") + 
  #use seismic colors; turn off color legend
  scale_color_manual(guide = "none", values = seismic_colors) + 
  #add a text label 
  annotate(geom = "text", x = 2, y = c(0.01,-0.05), label = c("grade bonus", "grade penalty"), 
           color = c("blue", "red"),vjust = -0.01, size = 4, angle = 270) +
  #labels
  labs(x = "Student identity", y = "Grade anomaly", color = "Student identity", 
       caption = "Mean ± 95% CI shown \n Dashed line is overall average grade") + 
  #make points in shape legend larger
  guides(shape = guide_legend(override.aes = list(size = 3))) +
  theme_seismic + 
  coord_flip()
```

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   On average, are students receiving a grade bonus or a grade penalty in this course? (refer to dashed line for overall course average)
-   Are there any demographic groups that are receiving more of a grade penalty or more of a grade bonus? How might the course structure or curriculum context affect possibility of a grade penalty or bonus?

:::

# 5. Examing the impact of students' systemic advantages

## How do systemic advantages experienced by students affect higher education course outcomes?

### The **Systemic Advantage Index** (SAI) is one approach. 
This metric takes into account multiple axes of student identities, including:

-   race/ethnicity

-   gender

-   socioeconomic status

-   parental education (i.e., first-generation college-going status)

SAI adds together all of the advantages a student may have across these four demographic axes and assigns an index. The table below shows SAI for multiple combinations of identities. For instance, a Latino, first-generation, low income man (column second from left) would be considered to have SAI = 1, while a white, continuing-generation woman from a high income family would be considered to have SAI = 3 (column second from right).

![](https://github.com/vsfarrar/SEISMIC-equity-measures/blob/main/SAI_assignment.tif)

The SAI approximates an intersectional approach, where we can consider how multiple axes of student identities may affect student experiences, and thus, course outcomes. However, SAI is limited in its intersectional approach in two ways. First, it collapses down various, diverse student identities within one index. For example, SAI = 2 contains six vastly different student identities and experiences, which undoubtedly do not share the same challenges and experiences in higher education. Second, SAI assumes all advantages act additively, rather than considering some cases where they interact in a non-additive way.

```{r default missing demographics to 0, message=FALSE, warning=FALSE}
#for SAI calculations, any NA demographic variables will need to be conservatively coded as 0 (defaulted to the majoritarian group)
#this allows those students to still be included in SAI calculations

#Convert Demographics to 0 (conservative, instead of excluding)
dat_coi <-
  dat_coi %>%
  mutate(across(.cols = c(ethniccode_cat, firstgen, female, lowincomeflag), as.character)) %>%
  tidyr::replace_na(list(ethniccode_cat = "0", firstgen = "0", female = "0", lowincomeflag = "0"))
```

```{r SAI calculation, message=FALSE, warning=FALSE}
#this code goes through all possible combinations of the 4 advantage axes and assigns an SAI based on that students' values
#as ethniccode_cat == 1 is the "BIPOC" label, all other categories are considered advantaged 
dat_coi <-
  dat_coi %>% mutate(sai = case_when(
    female == "0" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "0"  ~ "4",
    female == "1" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "0"  ~ "3",
    female == "0" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "3", 
    female == "0" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "1"  ~ "3", 
    female == "0" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "0"  ~ "3", 
    female == "0" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "2", 
    female == "0" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "2", 
    female == "0" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "0"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "1"  ~ "1", 
    female == "1" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "1",
    female == "1" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "1", 
    female == "0" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "1",
    female == "1" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "0",
    TRUE ~ "NA"))
```

### How do course grades and grade anomalies compare across levels of SAI?

The below plots show raw grades partitioned by the number of systemic advantages students have access to. Points represent means, errorbars 95% confidence intervals around the mean. The dashed line represents the overall course average, across all students and terms. The size of the point corresponds to the sample size across all terms of the course.

**Figure 12**
```{r raw grades by SAI, message=FALSE, warning=FALSE}

#sai colors
sai_colors <- c("0" = "#B35050", "1" = "#eb7e36", "2" = "#ffbe07", "3" = "#70ac49", "4" = "#4671c6")

#raw grades by SAI
dat_coi %>%
  mutate(sai = as.numeric(sai)) %>%
  add_count(sai, name = "n") %>% #add sample size per SAI
  ggplot(aes(x = sai, y = numgrade, color = as.factor(sai)))+ 
      stat_summary(aes(size = n), geom = "point", fun = "mean", 
                 position = position_dodge(0.2)) + 
    stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", 
                 width = 0.1, position = position_dodge(0.2)) +
   geom_hline(yintercept = mean_grade_coi, linetype = "dashed") +
  #use custom SAI colors
  scale_color_manual(values = sai_colors, guide = "none") +
  labs(x = "SAI", y = "Course grade", color = "SAI",
       caption = "Mean ± 95% CI shown \n Dashed line is overall average grade") + 
  theme_seismic + 
  coord_flip()
```

**Figure 13**
```{r grade anomaly by SAI, message=FALSE, warning=FALSE}
#grade anomaly by SAI

dat_coi %>%
  #exclude missing GPAO
  drop_na(gpao) %>%
  mutate(sai = as.numeric(sai)) %>%
  add_count(sai, name = "n") %>% #add sample size per SAI
  filter(crs_name == course_of_interest) %>%
  ggplot(aes(x = sai, y = numgrade-gpao, color = as.factor(sai)))+ 
      stat_summary(aes(size = n), geom = "point", fun = "mean", 
                 position = position_dodge(0.2)) + 
    stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", 
                 width = 0.1, position = position_dodge(0.2)) +
   geom_hline(yintercept = aga_coi, linetype = "dashed") + 
    #plot line and annotations for penalty vs bonus
  geom_hline(yintercept = 0) +  
    #use custom SAI colors
  scale_color_manual(values = sai_colors, guide = "none") +
  #add a text label 
  annotate(geom = "text", x = 2, y = c(0.01,-0.05), label = c("grade bonus", "grade penalty"), 
           color = c("blue", "red"),vjust = -0.01, size = 4, angle = 270) + 
  labs(x = "SAI", y = "Grade anomaly \n(course grade - GPAO)", color = "SAI",
       caption = "Mean ± 95% CI shown \n Dashed line is overall average grade anomaly") + 
  theme_seismic + 
  coord_flip()

```

In some STEM courses, there are significant gender gaps between men and women. (You may have already observed that in the above grade or grade anomaly distributions). To explore how gender may interact with other advantages, we can show SAI for men and women separately. In the below two panel plot, we can see the trends for GPAO and course grade across SAI levels for men (circles) and women (triangles). Points show means and errorbars 95% confidence intervals. If the 95% confidence intervals overlap between the genders, the two groups do not significantly differ.

**Figure 14**
```{r sai by gender, warning=FALSE, message=FALSE}
#2 panel plot of raw grades by SAI by gender and grade anomaly by SAI by gender

dat_coi %>%
  #exclude missing GPAO
  drop_na(gpao) %>%
  mutate(sai = as.numeric(sai)) %>%
  #edit sai to remove advantage conferred by gender
  mutate(sai = ifelse(female == 0, sai-1, sai)) %>%
  #pivot longer with all numeric metrics in one column for plotting
  pivot_longer(cols = c(numgrade,gpao),
               names_to = "metric",
               values_to = "value") %>%
  #rename the labels for the
  mutate(metric = factor(metric, labels = c("GPAO", "Course Grade"))) %>%
  ggplot(aes(x = sai, y = value, 
             color = as.factor(sai), shape = as.factor(female))) + 
  stat_summary(geom = "point", fun.data = mean_se, size = 3) + 
  stat_summary(geom = "errorbar", fun.data = mean_cl_normal, size = 1, width = 0) +
  scale_color_manual(values = sai_colors, guide = "none") +
  scale_shape_discrete(labels = c("M","W")) + 
  labs(x = "SAI (excluding Gender)", y = "GPA", shape = "Gender") + 
  facet_wrap(~metric) + 
  theme_seismic
```

```{r calculate advantages, warning = FALSE, message=FALSE}
#more granular than SAI - show specific advantage combinations
#"Marco plot" 

#create advantage labels for each group 
advantage_labels <- c("All", "W", "PEER", "LI","FG", "PEER + FG", "PEER + LI", "PEER + W", "FG + LI", "FG + W", "LI + W", "FG + LI + W", "PEER + FG + W", "PEER + LI+W", "PEER + FG + LI", "PEER + FG + LI + W")

#create variables that outline the number of advantages a student has at the levels of Gender, PEER, FirstGen, and LowIncome
dat_coi<-
dat_coi %>%
  mutate(peer = ifelse(ethniccode_cat == 1, 1, 0)) %>%
  mutate(advantage = case_when(
    female == "0" & peer == "0" & firstgen == "0" & lowincomeflag == "0"  ~ "0",
    female == "1" & peer == "0" & firstgen == "0" & lowincomeflag == "0"  ~ "1A",
    female == "0" & peer == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "1B", 
    female == "0" & peer == "0" & firstgen == "0" & lowincomeflag == "1"  ~ "1C", 
    female == "0" & peer == "0" & firstgen == "1" & lowincomeflag == "0"  ~ "1D", 
    female == "0" & peer == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "2A", 
    female == "0" & peer == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "2B", 
    female == "1" & peer == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "2C", 
    female == "0" & peer == "0" & firstgen == "1" & lowincomeflag == "1"  ~ "2D", 
    female == "1" & peer == "0" & firstgen == "1" & lowincomeflag == "0"  ~ "2E", 
    female == "1" & peer == "0" & firstgen == "0" & lowincomeflag == "1"  ~ "2F", 
    female == "1" & peer == "0" & firstgen == "1" & lowincomeflag == "1"  ~ "3A", 
    female == "1" & peer == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "3B",
    female == "1" & peer == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "3C", 
    female == "0" & peer == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "3D",
    female == "1" & peer == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "4",
    TRUE ~ "NA")) %>%
    mutate(advantage_no = 4 - as.numeric(str_extract(advantage, "(\\d)+"))) %>% #selects numbers from a string 
    mutate(advantage = as.factor(advantage)) 
```

::: {.questionbox data-latex=""}
::: {.center data-latex=""}
**Guiding questions:**
:::

-   How do different levels of SAI compare in terms of course outcomes? What is the relationship between SAI and overall grade?

-   If we see differences across levels of SAI, what elements of the course structure might perpetuate or exacerbate some of these differences in students' systemic advantages?

-   Can you think of any other systemic advantages not included in this index that likely influence students' outcomes in a course?

- What are challenges in the university environemnt that students with few systemic advantages encounter?

:::

### Acknowledgements

This report is heavily inspired by the Foundational Course Initiative reports from the University of Michigan, created by Dr. Heather Rypkema and refined by the Assessment Toolkit team. The R code in this report was initially created by Victoria Farrar (UC Davis) with feedback from Nita Tarchinski (Michigan), Matthew Steinwachs (UC Davis), Jenna Thomas (UC Davis), Tim McKay (Michigan), Heather Rypkema (Michigan), Marco Molinaro (University of Maryland) and Stefano Fiorini (Indiana University). This report was initially developed for the SEISMIC (Sloan Equity and Inclusion in STEM Introductory Courses) Project, funded by the National Science Foundation [DUE-2215398](https://www.nsf.gov/awardsearch/showAward?AWD_ID=2215398&HistoricalAwards=false) and the Alfred P. Sloan foundation.

```{r R coding resources, include = FALSE}
#R coding resources used

#"fadeplot" variations on raincloud plots
#https://dallasnova.rbind.io/post/efficient-data-visualization-with-faded-raincloud-plots-delete-boxplot/

```

```